#!/usr/bin/env bash
if [ -z "$TRIVY_TARGET_IMAGE" ]; then
  echo "Please set TRIVY_TARGET_IMAGE"
  exit 1
fi
DOCKER_VERSION_RESPONSE=$(docker -v)
EXPECTED_RESPONSE="Docker version "
if test "${DOCKER_VERSION_RESPONSE#*$EXPECTED_RESPONSE}" != "$DOCKER_VERSION_RESPONSE"; then
  if [ -n "$JOB_BASE_NAME" ]; then
    TRIVY_STEWARD_CONTAINER="$JOB_BASE_NAME"
  fi
  if [ -z "$TRIVY_STEWARD_CONTAINER" ]; then
    TRIVY_STEWARD_CONTAINER="trivy-steward"
  fi
  TRIVY_STEWARD_CONTAINER=${TRIVY_STEWARD_CONTAINER// /_}
  if [ -z "$TRIVY_STEWARD_IMAGE" ]; then
    export TRIVY_STEWARD_IMAGE="shibme/trivy-steward"
    docker pull "$TRIVY_STEWARD_IMAGE"
  fi

  TRIVY_STEWARD_CACHE="$(pwd)/trivy-cache"
  mkdir -p $TRIVY_STEWARD_CACHE
  TRIVY_STEWARD_WORKSPACE="$(pwd)/trivy-workspace"
  mkdir -p $TRIVY_STEWARD_WORKSPACE

  TRIVY_STEWARD_COMMAND="docker run --rm "
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e TRIVY_TARGET_IMAGE"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e TRIVY_STEWARD_PROJECT"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e TRIVY_STEWARD_SKIP_SCAN"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_CONFIG"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PROJECT_KEY"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_ISSUE_TYPE"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITY_P0"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITY_P1"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITY_P2"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITY_P3"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITY_P4"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_TRACKER_NAME"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_TRACKER_ENDPOINT"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_TRACKER_USERNAME"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_TRACKER_PASSWORD"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_TRACKER_API_KEY"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_DRY_RUN"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_EXIT_CODE_NEW_ISSUES"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_EXIT_CODE_FAILURE"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_UPDATE_SUMMARY"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_UPDATE_DESCRIPTION"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_UPDATE_LABELS"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITIZE_UP"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_PRIORITIZE_DOWN"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_ASSIGNEE"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_REOPEN_STATUS"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_RESOLVED_STATUSES"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_CLOSED_STATUSES"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_IGNORE_LABELS"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_IGNORE_STATUSES"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_AUTO_REOPEN_AFTER"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_AUTO_REOPEN_TRANSITION"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_AUTO_REOPEN_COMMENT"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_AUTO_RESOLVE_AFTER"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_AUTO_RESOLVE_TRANSITION"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -e STEWARD_AUTO_RESOLVE_COMMENT"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND --name $TRIVY_STEWARD_CONTAINER"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -v $TRIVY_STEWARD_CACHE:/root/.cache/"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -v $TRIVY_STEWARD_WORKSPACE:/trivy-steward/"
  TRIVY_STEWARD_COMMAND="$TRIVY_STEWARD_COMMAND -v /var/run/docker.sock:/var/run/docker.sock $TRIVY_STEWARD_IMAGE"

  echo "Now running: $TRIVY_STEWARD_CONTAINER"
  echo $TRIVY_STEWARD_COMMAND | bash
else
  echo "Please install docker client before you begin."
  exit 1
fi