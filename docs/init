#!/usr/bin/env bash
DOCKER_VERSION_RESPONSE=$(docker -v)
EXPECTED_RESPONSE="Docker version "
if test "${DOCKER_VERSION_RESPONSE#*$EXPECTED_RESPONSE}" != "$DOCKER_VERSION_RESPONSE"; then
  if [ -n "$JOB_BASE_NAME" ]; then
    DOCKERINSPECT_CONTAINER="$JOB_BASE_NAME"
  fi
  if [ -z "$DOCKERINSPECT_CONTAINER" ]; then
    DOCKERINSPECT_CONTAINER="DockerInspect-$RANDOM"
  fi
  DOCKERINSPECT_CONTAINER=${DOCKERINSPECT_CONTAINER// /_}
  if [ -z "$DOCKERINSPECT_IMAGE" ]; then
    export DOCKERINSPECT_IMAGE="shibme/dockerinspect"
  fi
  docker pull "$DOCKERINSPECT_IMAGE"

  DOCKERINSPECT_CACHE="$(pwd)/dockerinspect/cache"
  mkdir -p $DOCKERINSPECT_CACHE
  DOCKERINSPECT_WORKSPACE="$(pwd)/dockerinspect/workspace"
  mkdir -p $DOCKERINSPECT_WORKSPACE

  DOCKERINSPECT_COMMAND="docker run --rm "
  DOCKERINSPECT_COMMAND="$DOCKERINSPECT_COMMAND --env-file <(env | grep DOCKERINSPECT_)"
  DOCKERINSPECT_COMMAND="$DOCKERINSPECT_COMMAND --env-file <(env | grep STEWARD_)"
  DOCKERINSPECT_COMMAND="$DOCKERINSPECT_COMMAND --name $DOCKERINSPECT_CONTAINER"
  DOCKERINSPECT_COMMAND="$DOCKERINSPECT_COMMAND -v $DOCKERINSPECT_CACHE:/root/.cache/"
  DOCKERINSPECT_COMMAND="$DOCKERINSPECT_COMMAND -v $DOCKERINSPECT_WORKSPACE:/dockerinspect/"
  DOCKERINSPECT_COMMAND="$DOCKERINSPECT_COMMAND -v /var/run/docker.sock:/var/run/docker.sock $DOCKERINSPECT_IMAGE"

  echo "Now running: $DOCKERINSPECT_CONTAINER"
  echo $DOCKERINSPECT_COMMAND | bash
else
  echo "Please install docker client before you begin."
  exit 1
fi